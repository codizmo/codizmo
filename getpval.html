<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parameter Selector</title>
    <style>
        /* Minimal styling for parameter selector page */
        body {
            font-family: system-ui, sans-serif;
            max-width: 400px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        select, button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background: #0056b3; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Parameter Selection</h2>
        <p>Choose a value for the parameter:</p>

        <form id="form">
            <select id="select" required>
                <option value="">-- Select Option --</option>
                <option value="basic">Basic Configuration</option>
                <option value="advanced">Advanced Settings</option>
                <option value="custom">Custom Parameters</option>
                <option value="default">Default Template</option>
                <option value="expert">Expert Mode</option>
            </select>
            <button type="submit">Send Selection</button>
            <button type="button" id="cancel">Cancel</button>
        </form>

        <div id="messages"></div>
    </div>

    <script>
        /**
         * MINIMAL PARAMETER SELECTOR FOR OPENSCAD
         * =======================================
         *
         * This page demonstrates how to create a parameter selector that works
         * with OpenSCAD's parameter system via postMessage API.
         *
         * USAGE:
         * - Can be opened in iframe (URL ends with #) or popup window (URL without #)
         * - Automatically detects its context (iframe vs popup)
         * - Requests the parameter name from parent window
         * - Sends selected value back to parent via postMessage
         *
         * INTEGRATION:
         * In OpenSCAD parameter comments, use:
         *   // param Level [Level]: Description [Link Text](https://example.com/getpval.html)
         *   // param Level [Level]: Description [Link Text](https://example.com/getpval.html#)
         *
         * The # suffix determines iframe (with #) vs popup (without #) mode.
         */

        // Detect context: iframe or popup window
        const isIframe = window.parent !== window;
        const isPopup = window.opener && window.opener !== window;
        const parentWindow = isIframe ? window.parent : window.opener;

        let targetParameter = null; // Will be set by parent window

        // Utility function to show messages
        function showMessage(text, type = 'info') {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            document.getElementById('messages').appendChild(div);

            // Auto-remove after 3 seconds
            setTimeout(() => div.remove(), 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (!parentWindow) {
                showMessage('Error: This page must be opened from OpenSCAD parameter panel', 'error');
                document.getElementById('form').style.display = 'none';
                return;
            }

            // Request parameter name from parent
            parentWindow.postMessage({
                type: 'request-parameter-name',
                source: 'parameter-selector'
            }, '*');

            showMessage('Loading...', 'success');
        });

        // Handle form submission
        document.getElementById('form').addEventListener('submit', function(e) {
            e.preventDefault();

            const value = document.getElementById('select').value;
            if (!value) {
                showMessage('Please select an option', 'error');
                return;
            }

            // Send selection to parent window
            parentWindow.postMessage({
                type: 'selection',
                value: value,
                parameterName: targetParameter,
                source: 'parameter-selector'
            }, '*');

            showMessage('Selection sent successfully!', 'success');
        });

        // Handle cancel button
        document.getElementById('cancel').addEventListener('click', function() {
            parentWindow.postMessage({
                type: 'selection-cancelled',
                source: 'parameter-selector'
            }, '*');
            window.close();
        });

        // Listen for parameter name from parent
        window.addEventListener('message', function(event) {
            // Verify message is from valid parent window
            if (event.source !== parentWindow) return;

            if (event.data.type === 'parameter-name-response') {
                targetParameter = event.data.parameterName;
                showMessage(`Ready for parameter: ${targetParameter}`, 'success');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('cancel').click();
            }
        });

    </script>
</body>
</html>
